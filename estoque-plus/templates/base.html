<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ESTOQUE NUVEM{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='menu-override.css') }}">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/5164/5164023.png">
    
    <style>
        .flash-messages-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050;
            width: 90%;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <div class="mobile-header d-lg-none">
        <div class="header-content">
            <button id="mobileMenuToggle" class="menu-button">
                <i class="fas fa-bars"></i>
            </button>
            <a href="{{ url_for('dashboard') }}" class="logo-link">
                <img src="{{ url_for('images', filename='logo.png') }}" alt="Estoque Nuvem" class="logo-mobile">
            </a>
            
            <div class="user-action-button">
                {% if current_user.is_authenticated %}
                    
                    <a href="{{ url_for('logout') }}" class="action-button" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                {% elif request.endpoint == 'login' %}
                    
                    <a href="{{ url_for('registro') }}" class="action-button" title="Registro">
                        <i class="fas fa-user-plus"></i>
                    </a>
                {% else %}
                    
                    <a href="{{ url_for('login') }}" class="action-button" title="Login">
                        <i class="fas fa-sign-in-alt"></i>
                    </a>
                {% endif %}
            </div>
            
        </div>
    </div>

    <div id="mobileOverlay" class="mobile-overlay"></div>

    <nav id="mobileDrawer" class="mobile-drawer d-lg-none">
        <div class="drawer-header">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    {% if current_user.is_authenticated %}
                        <h6 class="user-name">Olá, {{ current_user.username }}</h6>
                        <p class="user-role">Usuário Logado</p>
                    {% else %}
                        <h6 class="user-name">Bem-vindo(a)</h6>
                        <p class="user-role">Visitante</p>
                    {% endif %}
                </div>
            </div>
            <button id="drawerClose" class="close-button">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="drawer-content">
            {% if current_user.is_authenticated %}
            <div class="drawer-section">
                <h6 class="section-title">Menu Principal</h6>
                <div class="drawer-menu">
                    <a href="{{ url_for('dashboard') }}" class="drawer-item {% if request.endpoint == 'dashboard' or request.endpoint == 'index' %}active{% endif %}">
                        <i class="fas fa-chart-pie"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="{{ url_for('produtos_list') }}" class="drawer-item {% if request.endpoint == 'produtos_list' or request.endpoint == 'produto_detalhe' or request.endpoint == 'edit' %}active{% endif %}">
                        <i class="fas fa-warehouse"></i>
                        <span>Inventário</span>
                    </a>
                    <a href="{{ url_for('add') }}" class="drawer-item {% if request.endpoint == 'add' %}active{% endif %}">
                        <i class="fas fa-box"></i>
                        <span>Adicionar Produto</span>
                    </a>
                    <a href="#" class="drawer-item">
                        <i class="fas fa-arrow-right-to-bracket"></i>
                        <span>Entradas</span>
                    </a>
                    <a href="#" class="drawer-item">
                        <i class="fas fa-arrow-right-from-bracket"></i>
                        <span>Saídas</span>
                    </a>
                </div>
            </div>
            
            <div class="drawer-section">
                <h6 class="section-title">Gerenciamento</h6>
                <div class="drawer-menu">
                    <a href="#" class="drawer-item">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                    </a>
                    <a href="#" class="drawer-item">
                        <i class="fas fa-truck"></i>
                        <span>Fornecedores</span>
                    </a>
                </div>
            </div>
            {% endif %}
            
            <div class="drawer-section">
                <h6 class="section-title">Conta</h6>
                <div class="drawer-menu">
                    {% if current_user.is_authenticated %}
                        <a href="{{ url_for('logout') }}" class="drawer-item">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Sair</span>
                        </a>
                    {% else %}
                        <a href="{{ url_for('login') }}" class="drawer-item {% if request.endpoint == 'login' %}active{% endif %}">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Login</span>
                        </a>
                        <a href="{{ url_for('registro') }}" class="drawer-item {% if request.endpoint == 'registro' %}active{% endif %}">
                            <i class="fas fa-user-plus"></i>
                            <span>Registro</span>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="main-layout-wrapper">
        <nav id="sidebarMenu" class="nav-sidebar">
            <div class="sidebar-header d-flex justify-content-between align-items-center">
                <a href="{{ url_for('dashboard') }}" class="header-link" title="Ir para página inicial">
                    <img src="{{ url_for('images', filename='logo.png') }}" alt="Estoque Nuvem" class="logo">
                </a>
            </div>
            <ul class="sidebar-menu">
                {% if current_user.is_authenticated %}
                <li class="menu-item {% if request.endpoint == 'dashboard' or request.endpoint == 'index' %}active{% endif %}">
                    <a href="{{ url_for('dashboard') }}" class="d-flex align-items-center" title="Dashboard">
                        <i class="fas fa-chart-pie"></i>
                        <span class="menu-text">Dashboard</span>
                    </a>
                </li>
                <li class="menu-item {% if request.endpoint == 'produtos_list' or request.endpoint == 'produto_detalhe' or request.endpoint == 'edit' %}active{% endif %}">
                    <a href="{{ url_for('produtos_list') }}" class="d-flex align-items-center" title="Inventário">
                        <i class="fas fa-warehouse"></i>
                        <span class="menu-text">Inventário</span>
                    </a>
                </li>
                <li class="menu-item {% if request.endpoint == 'add' %}active{% endif %}">
                    <a href="{{ url_for('add') }}" class="d-flex align-items-center" title="Adicionar Produto">
                        <i class="fas fa-box"></i>
                        <span class="menu-text">Adicionar Produto</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="d-flex align-items-center" title="Entradas">
                        <i class="fas fa-arrow-right-to-bracket"></i>
                        <span class="menu-text">Entradas</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="d-flex align-items-center" title="Saídas">
                        <i class="fas fa-arrow-right-from-bracket"></i>
                        <span class="menu-text">Saídas</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="d-flex align-items-center" title="Clientes">
                        <i class="fas fa-users"></i>
                        <span class="menu-text">Clientes</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="d-flex align-items-center" title="Fornecedores">
                        <i class="fas fa-truck"></i>
                        <span class="menu-text">Fornecedores</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="d-flex align-items-center" title="Suporte">
                        <i class="fas fa-headset"></i>
                        <span class="menu-text">Suporte</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="d-flex align-items-center" title="Configurações">
                        <i class="fas fa-cog"></i>
                        <span class="menu-text">Configurações</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="{{ url_for('logout') }}" class="d-flex align-items-center" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="menu-text">Sair</span>
                    </a>
                </li>
                {% else %}
                <li class="menu-item {% if request.endpoint == 'login' %}active{% endif %}">
                    <a href="{{ url_for('login') }}" class="d-flex align-items-center" title="Login">
                        <i class="fas fa-sign-in-alt"></i>
                        <span class="menu-text">Login</span>
                    </a>
                </li>
                <li class="menu-item {% if request.endpoint == 'registro' %}active{% endif %}">
                    <a href="{{ url_for('registro') }}" class="d-flex align-items-center" title="Registro">
                        <i class="fas fa-user-plus"></i>
                        <span class="menu-text">Registro</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        
        <div class="main-content">
            <div class="flash-messages-container">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>

            {% block content %}
            {% endblock %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const drawer = document.getElementById('mobileDrawer');
        const overlay = document.getElementById('mobileOverlay');
        const menuToggle = document.getElementById('mobileMenuToggle');
        const drawerClose = document.getElementById('drawerClose');
        const sidebar = document.getElementById('sidebarMenu');
        const mainContent = document.querySelector('.main-content');

        const toggleDrawer = () => {
            drawer.classList.toggle('show');
            overlay.classList.toggle('show');
            
            document.body.style.overflow = drawer.classList.contains('show') ? 'hidden' : 'auto';
        };

        if (menuToggle) menuToggle.addEventListener('click', toggleDrawer);
        if (drawerClose) drawerClose.addEventListener('click', toggleDrawer);
        if (overlay) overlay.addEventListener('click', toggleDrawer);

        
        window.addEventListener('resize', function() {
            
            setTimeout(() => {
                if (window.innerWidth >= 992 && drawer.classList.contains('show')) {
                    toggleDrawer();
                }
            }, 250);
        });

        
        const drawerItems = document.querySelectorAll('.drawer-item');
        drawerItems.forEach(item => {
            item.addEventListener('click', function() {
                if (window.innerWidth < 992) {
                    setTimeout(toggleDrawer, 100); 
                }
            });
        });

        
        if (window.innerWidth >= 992) {
            
            sidebar.classList.remove('collapsed'); 
            mainContent.classList.remove('expanded');
        }

        
        
        const flashAlerts = document.querySelectorAll('.flash-messages-container .alert');
        const timeout = 5000; 

        flashAlerts.forEach(alert => {
            
            const closeButton = alert.querySelector('.btn-close');

            
            if (closeButton) {
                setTimeout(() => {
                    
                    closeButton.click(); 
                }, timeout);
            }
        });
        
        
        
        const searchInput = document.getElementById('search-input');
        const suggestionsList = document.getElementById('suggestions-list');
        
        
        if (!searchInput || !suggestionsList) return;

        let debounceTimer;

        const fetchSuggestions = (query) => {
            if (query.length < 2) { 
                suggestionsList.innerHTML = '';
                suggestionsList.classList.remove('show');
                return;
            }

            
            fetch(`/search_autocomplete?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsList.innerHTML = ''; 
                    
                    if (data.length > 0) {
                        data.forEach(item => {
                            const suggestionItem = document.createElement('div');
                            suggestionItem.classList.add('suggestion-item');
                            suggestionItem.textContent = item.nome;
                            
                            
                            suggestionItem.addEventListener('click', () => {
                                searchInput.value = item.nome;
                                suggestionsList.classList.remove('show');
                                document.getElementById('search-form').submit();
                            });
                            
                            suggestionsList.appendChild(suggestionItem);
                        });
                        suggestionsList.classList.add('show'); 
                    } else {
                        suggestionsList.classList.remove('show');
                    }
                })
                .catch(error => {
                    console.error('Erro na busca instantânea:', error);
                    suggestionsList.classList.remove('show');
                });
        };

        
        searchInput.addEventListener('keyup', (e) => {
            const query = searchInput.value.trim();
            clearTimeout(debounceTimer);
            
            
            debounceTimer = setTimeout(() => fetchSuggestions(query), 300);
        });
        
        
        document.addEventListener('click', (e) => {
            if (!suggestionsList.contains(e.target) && e.target !== searchInput) {
                suggestionsList.classList.remove('show');
            }
        });
        
        
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                suggestionsList.classList.remove('show');
            }
        });
    });
    </script>
</body>
</html>